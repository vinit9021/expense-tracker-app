
{% extends 'base.html' %}

{% block title %}My Expenses{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0 text-gray-800">My Expenses</h1>
  <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#addExpenseCollapse" aria-expanded="false" aria-controls="addExpenseCollapse">
    <i class="bi bi-plus-lg"></i> Add Expense
  </button>
</div>


<div class="collapse" id="addExpenseCollapse">
  <div class="card card-body mb-4">
    <form action="{{ url_for('add_expense') }}" method="POST">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="title" class="form-label">Title</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>
        <div class="col-md-6">
          <label for="amount" class="form-label">Amount</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
          </div>
        </div>
        <div class="col-12">
          <label for="description" class="form-label">Description (Optional)</label>
          <textarea class="form-control" id="description" name="description" rows="2"></textarea>
        </div>
        <div class="col-md-6">
          <label for="category" class="form-label">Category</label>
          <select class="form-select" id="category" name="category" required>
            <option value="" disabled selected>Choose a category...</option>
            <option value="food">Food</option>
            <option value="travel">Travel</option>
            <option value="utilities">Utilities</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="spent_on" class="form-label">Spent On</label>
          <input type="date" class="form-control" id="spent_on" name="spent_on" required>
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">Save Expense</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-5">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Expense Breakdown</h5>
        <canvas id="expenseChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-7">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Statistics</h5>
        <div id="statistics-content">
          <p>Loading statistics...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Category</th>
        <th>Date</th>
        <th class="text-end">Amount</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for expense in expenses %}
      <tr>
        <td>
          <strong>{{ expense.title }}</strong>
          <p class="text-muted mb-0 small">{{ expense.description }}</p>
        </td>
        <td><span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">{{ expense.category|capitalize }}</span></td>
        <td>{{ expense.spent_on.strftime('%b %d, %Y') }}</td>
        <td class="text-end"><strong>${{ "%.2f"|format(expense.amount) }}</strong></td>
        <td class="text-center">
          <a href="{{ url_for('edit_expense', id=expense.id) }}" class="btn btn-sm btn-outline-secondary border-0" title="Edit">
            <i class="bi bi-pencil-square"></i>
          </a>
          <form action="{{ url_for('delete_expense', id=expense.id) }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Delete" onclick="return confirm('Are you sure you want to delete this expense?');">
              <i class="bi bi-trash3"></i>
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center py-5">
          <p class="text-muted">No expenses found. Add your first one!</p>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const expenseChartCanvas = document.getElementById('expenseChart');
  const statisticsContent = document.getElementById('statistics-content');
  let expenseChart;

  async function fetchDataAndRender() {
    try {
      const response = await fetch('/api/expenses');
      const data = await response.json();
      
      renderChart(data);
      renderStatistics(data);
    } catch (error) {
      console.error('Error fetching expense data:', error);
      statisticsContent.innerHTML = '<p class="text-danger">Could not load statistics.</p>';
    }
  }

  function renderChart(data) {
    const categories = data.map(item => item.category);
    const amounts = data.map(item => item.total_amount);

    if (expenseChart) {
      expenseChart.destroy();
    }

    expenseChart = new Chart(expenseChartCanvas, {
      type: 'pie',
      data: {
        labels: categories.map(c => c.charAt(0).toUpperCase() + c.slice(1)),
        datasets: [{
          data: amounts,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
          ],
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: false
          }
        }
      }
    });
  }

  function renderStatistics(data) {
    const totalExpenses = data.reduce((sum, item) => sum + item.total_amount, 0);
    const topCategory = data.length > 0 ? data.reduce((max, item) => item.total_amount > max.total_amount ? item : max, data[0]) : null;

    let statsHtml = `
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Total Expenses:</span>
        <span class="badge bg-success-subtle text-success-emphasis fs-6">${formatCurrency(totalExpenses)}</span>
      </div>
    `;

    if (topCategory) {
      statsHtml += `
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-bold">Top Category:</span>
          <span class="badge bg-info-subtle text-info-emphasis">${topCategory.category.charAt(0).toUpperCase() + topCategory.category.slice(1)}</span>
        </div>
      `;
    } else {
        statsHtml += '<p class="text-muted">No expense data to show statistics.</p>';
    }
    
    statisticsContent.innerHTML = statsHtml;
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
  }

  // Initial fetch
  fetchDataAndRender();

  // Optionally, refresh data when an expense is added/deleted/updated.
  // This requires identifying the forms and listening to their submit events.
  const addExpenseForm = document.querySelector('form[action="{{ url_for('add_expense') }}"]');
  if(addExpenseForm) {
    addExpenseForm.addEventListener('submit', function() {
      // A slight delay to allow the database to update
      setTimeout(fetchDataAndRender, 1000); 
    });
  }
  
  // For edit and delete, it's more complex as they are multiple forms.
  // A simple approach is to refetch on any form submission that seems successful.
  document.querySelectorAll('form[action*="/delete/"], form[action*="/edit/"]').forEach(form => {
    form.addEventListener('submit', function() {
      setTimeout(fetchDataAndRender, 1000);
    });
  });

});
</script>
{% endblock %}
